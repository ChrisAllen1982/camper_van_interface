<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WiFi</title>
  <link rel="stylesheet" href="/static/app.css">

  <style>
    .topnav{display:flex;gap:10px;justify-content:space-between;margin-bottom:12px}
    .navlinks{display:flex;gap:10px;flex-wrap:wrap}
    .navlink{padding:10px 14px;border-radius:999px;font-weight:900;text-decoration:none;background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.25)}
    .navlink.active{background:rgba(255,255,255,.25)}

    .kv{display:grid;grid-template-columns:160px 1fr;gap:10px;padding:8px 0;border-bottom:1px dashed rgba(0,0,0,.15)}
    .k{font-weight:900}
    .v{font-weight:800;word-break:break-word}
    .msg{margin-top:12px;padding:10px 12px;border-radius:14px;font-weight:900;background:rgba(255,255,255,.55)}
    .msg.err{background:rgba(255,0,0,.10)}
    .msg.success{background:rgba(0,255,0,.10)}
    
    /* WiFi network list styling */
    .network-list{display:flex;flex-direction:column;gap:8px}
    .network-item{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(255,255,255,.65);border-radius:12px;border:1px solid rgba(0,0,0,.08);transition:all 0.2s ease}
    .network-item:hover{background:rgba(255,255,255,.85);border-color:rgba(0,0,0,.15);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .network-info{flex:1;min-width:0}
    .network-ssid{font-weight:900;font-size:16px;margin-bottom:4px;color:#1a0f10}
    .network-details{font-size:13px;font-weight:700;color:rgba(26,15,16,.6)}
    .network-signal{display:inline-block;padding:2px 8px;border-radius:6px;font-size:12px;font-weight:900;margin-left:8px}
    .network-signal.strong{background:rgba(0,200,0,.2);color:#006400}
    .network-signal.medium{background:rgba(255,165,0,.2);color:#cc5200}
    .network-signal.weak{background:rgba(255,0,0,.2);color:#cc0000}
    .network-security{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .security-badge{display:inline-block;padding:3px 8px;border-radius:6px;background:rgba(26,15,16,.08);color:rgba(26,15,16,.85);font-size:11px;font-weight:900;border:1px solid rgba(26,15,16,.12)}
    .network-actions{display:flex;gap:8px;align-items:center}
    .mini-connect-btn{padding:8px 14px;border-radius:8px;border:1px solid rgba(196,0,18,.4);background:linear-gradient(135deg,#c40012,#7d000a);color:rgba(255,255,255,.95);font-weight:900;font-size:13px;cursor:pointer;transition:all 0.2s ease;box-shadow:0 2px 8px rgba(196,0,18,.3)}
    .mini-connect-btn:hover{background:linear-gradient(135deg,#d81020,#8d001a);transform:translateY(-1px);box-shadow:0 4px 12px rgba(196,0,18,.4)}
    .mini-connect-btn:active{transform:translateY(0)}
    .mini-connect-btn:disabled{opacity:0.5;cursor:not-allowed}
    
    /* Saved network badge */
    .saved-badge{padding:4px 10px;border-radius:6px;background:rgba(26,15,16,.08);color:rgba(26,15,16,.85);font-size:12px;font-weight:900;border:1px solid rgba(26,15,16,.10)}
    
    /* Modal styles */
    .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-content{background:#fff;border-radius:18px;padding:24px;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .modal-header{font-size:20px;font-weight:900;margin-bottom:16px;color:#1a0f10}
    .modal-body{margin-bottom:20px}
    .modal-input{width:100%;padding:12px;border:2px solid rgba(26,15,16,.15);border-radius:10px;font-size:14px;font-weight:700;margin-top:8px;box-sizing:border-box}
    .modal-input:focus{outline:none;border-color:rgba(26,15,16,.4)}
    .modal-footer{display:flex;gap:10px;justify-content:flex-end}
    .modal-btn{padding:10px 20px;border-radius:10px;border:1px solid rgba(26,15,16,.18);font-weight:900;cursor:pointer;transition:all 0.2s ease}
    .modal-btn-primary{background:rgba(26,15,16,.92);color:rgba(255,255,255,.95);border-color:rgba(26,15,16,.92)}
    .modal-btn-primary:hover{background:rgba(26,15,16,.85);transform:translateY(-1px)}
    .modal-btn-secondary{background:rgba(255,255,255,.65);color:rgba(26,15,16,.92);border:1px solid rgba(26,15,16,.18)}
    .modal-btn-secondary:hover{background:rgba(255,255,255,.78)}
  </style>
</head>

<body class="bg">
<div class="wrap">

  <div class="topnav">
    <div class="navlinks">
      <a class="navlink" href="/">Home</a>
      <a class="navlink active" href="/wifi">WiFi</a>
      <a class="navlink" href="/vehicle">Vehicle</a>
      <a class="navlink" href="/power">Power</a>
      <a class="navlink" href="/settings">Settings</a>
    </div>
  </div>

  <section class="hero">
    <h1>WiFi</h1>
    <p>Status, saved networks and scan results.</p>

    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
      <span class="pill"><span id="statusText">Ready</span></span>
      <button id="refreshBtn" class="btn btn-primary">Refresh</button>
      <button id="scanBtn" class="btn btn-ghost">Scan</button>
    </div>
  </section>

  <section class="section">
    <div class="card">
      <div class="card-h"><h2>Status</h2></div>
      <div class="card-b">
        <div id="statusArea"></div>
        <div id="msgWrap"></div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="card">
      <div class="card-h"><h2>Saved networks</h2></div>
      <div class="card-b">
        <div id="savedArea"></div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="card">
      <div class="card-h"><h2>Scan results</h2></div>
      <div class="card-b">
        <div id="scanArea"></div>
      </div>
    </div>
  </section>

</div>

<!-- Connect Modal -->
<div id="connectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Connect to <span id="modalSSID"></span></div>
    <div class="modal-body">
      <label for="passwordInput" style="font-weight:900;font-size:14px;display:block;margin-bottom:4px">Password</label>
      <input type="password" id="passwordInput" class="modal-input" placeholder="Enter network password" />
    </div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary" onclick="closeConnectModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="submitConnect()">Connect</button>
    </div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
const esc = s => (s ?? "").toString().replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
function kv(k,v){return `<div class="kv"><div class="k">${esc(k)}</div><div class="v">${esc(v ?? "—")}</div></div>`}

let savedNetworksCache = [];
let currentConnectSSID = null;

function setMsg(text, kind){
  const wrap = $("msgWrap");
  if (!text) { wrap.innerHTML = ""; return; }
  const cls = kind === "err" ? "msg err" : kind === "success" ? "msg success" : "msg";
  wrap.innerHTML = `<div class="${cls}">${esc(text)}</div>`;
}

function getSignalClass(sig){
  const s = parseInt(sig);
  if (s >= -50) return 'strong';
  if (s >= -70) return 'medium';
  return 'weak';
}

function getSignalText(sig){
  const s = parseInt(sig);
  if (s >= -50) return 'Excellent';
  if (s >= -70) return 'Good';
  return 'Weak';
}

function parseFlags(flagsStr){
  if (!flagsStr) return [];
  // Match anything inside brackets like [WPA2-SAE-CCMP] or [ESS]
  const matches = flagsStr.match(/\[([^\]]+)\]/g);
  return matches ? matches.map(m => m.slice(1, -1)) : [];
}

function isSaved(ssid){
  return savedNetworksCache.some(n => n.ssid === ssid);
}

function openConnectModal(ssid){
  currentConnectSSID = ssid;
  $("modalSSID").textContent = ssid;
  $("passwordInput").value = "";
  $("connectModal").classList.add("show");
}

function closeConnectModal(){
  $("connectModal").classList.remove("show");
  currentConnectSSID = null;
}

async function submitConnect(){
  const password = $("passwordInput").value;
  if (!currentConnectSSID) return;
  
  closeConnectModal();
  $("statusText").textContent = "Connecting…";
  setMsg("", null);
  
  try{
    const result = await api("/api/connect", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ssid: currentConnectSSID, password: password || null })
    });
    setMsg(result.message || "Connected successfully", "success");
    $("statusText").textContent = "Connected";
    
    // Refresh status after connection attempt
    setTimeout(async () => {
      await refreshStatus();
      await refreshSaved();
    }, 3000);
  }catch(e){
    $("statusText").textContent = "Error";
    setMsg("Connection failed: " + (e.message || String(e)), "err");
  }
}
async function readJsonOrThrow(res){
  const ct = (res.headers.get("content-type") || "").toLowerCase();
  if (ct.includes("application/json")){
    const j = await res.json();
    if (!res.ok) throw new Error(j.detail || ("HTTP " + res.status));
    return j;
  }
  const t = await res.text();
  throw new Error(t || ("HTTP " + res.status));
}
async function api(url, opts){
  const res = await fetch(url, opts);
  return readJsonOrThrow(res);
}

async function refreshStatus(){
  $("statusText").textContent = "Refreshing…";
  setMsg("", null);
  try{
    const s = await api("/api/status");
    let html = "";
    html += kv("Connected", s.connected ? "Yes" : "No");
    html += kv("SSID", s.ssid || "—");
    html += kv("IP", s.ip || "—");
    html += kv("WPA state", s.wpa_state || "—");
    $("statusArea").innerHTML = html;
    $("statusText").textContent = "Ready";
  }catch(e){
    $("statusText").textContent = "Error";
    setMsg(e.message || String(e), "err");
  }
}

async function refreshSaved(){
  try{
    const s = await api("/api/saved_networks");
    const nets = s.networks || [];
    savedNetworksCache = nets;
    
    if (!nets.length){
      $("savedArea").innerHTML = "<div class='meta'>No saved networks</div>";
      return;
    }
    let html = "<div class='network-list'>";
    for (const n of nets){
      html += `<div class='network-item'>`;
      html += `<div class='network-info'>`;
      html += `<div class='network-ssid'>${esc(n.ssid || "—")}</div>`;
      html += `<div class='network-details'>Network ID: ${esc(n.id ?? "—")}</div>`;
      html += `</div>`;
      html += `<div class='saved-badge'>Saved</div>`;
      html += `</div>`;
    }
    html += "</div>";
    $("savedArea").innerHTML = html;
  }catch{
    $("savedArea").innerHTML = "<div class='meta'>Unable to read saved networks</div>";
  }
}

async function scan(){
  $("statusText").textContent = "Scanning…";
  setMsg("", null);
  try{
    const r = await api("/api/scan", { method: "POST" });
    const aps = r.aps || [];
    if (!aps.length){
      $("scanArea").innerHTML = "<div class='meta'>No access points found</div>";
      $("statusText").textContent = "Ready";
      return;
    }
    
    let html = "<div class='network-list'>";
    for (const ap of aps){
      const ssid = ap.ssid || "(hidden)";
      const saved = isSaved(ssid);
      const sigClass = getSignalClass(ap.sig);
      const sigText = getSignalText(ap.sig);
      const flags = parseFlags(ap.flags);
      
      html += `<div class='network-item'>`;
      html += `<div class='network-info'>`;
      html += `<div class='network-ssid'>${esc(ssid)}</div>`;
      html += `<div class='network-details'>`;
      html += `<span class='network-signal ${sigClass}'>${sigText} (${esc(ap.sig)} dBm)</span>`;
      html += `</div>`;
      if (flags.length > 0) {
        html += `<div class='network-security'>`;
        for (const flag of flags) {
          html += `<span class='security-badge'>${esc(flag)}</span>`;
        }
        html += `</div>`;
      }
      html += `</div>`;
      html += `<div class='network-actions'>`;
      if (saved) {
        html += `<div class='saved-badge'>Saved</div>`;
      }
      if (ssid !== "(hidden)") {
        html += `<button class='mini-connect-btn' onclick='openConnectModal(${JSON.stringify(ssid)})'>Connect</button>`;
      }
      html += `</div>`;
      html += `</div>`;
    }
    html += "</div>";
    $("scanArea").innerHTML = html;
    $("statusText").textContent = "Ready";
  }catch(e){
    $("statusText").textContent = "Error";
    setMsg(e.message || String(e), "err");
  }
}

$("refreshBtn").addEventListener("click", async ()=>{ await refreshStatus(); await refreshSaved(); });
$("scanBtn").addEventListener("click", scan);

(async () => {
  await refreshStatus();
  await refreshSaved();
})();
</script>
</body>
</html>
