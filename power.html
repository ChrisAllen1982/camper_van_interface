<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Power</title>
  <link rel="stylesheet" href="/static/app.css">

  <style>
    .topnav{display:flex;gap:10px;justify-content:space-between;margin-bottom:12px}
    .navlinks{display:flex;gap:10px;flex-wrap:wrap}
    .navlink{padding:10px 14px;border-radius:999px;font-weight:900;text-decoration:none;background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.25)}
    .navlink.active{background:rgba(255,255,255,.25)}

    .kv{display:grid;grid-template-columns:180px 1fr;gap:10px;padding:8px 0;border-bottom:1px dashed rgba(0,0,0,.15)}
    .k{font-weight:900}
    .v{font-weight:800;word-break:break-word}

    .msg{margin-top:12px;padding:10px 12px;border-radius:14px;font-weight:900;background:rgba(255,255,255,.55)}
    .msg.err{background:rgba(255,0,0,.10)}
    pre{white-space:pre-wrap}
  </style>
</head>

<body class="bg">
<div class="wrap">

  <div class="topnav">
    <div class="navlinks">
      <a class="navlink" href="/">Home</a>
      <a class="navlink" href="/wifi">WiFi</a>
      <a class="navlink" href="/vehicle">Vehicle</a>
      <a class="navlink active" href="/power">Power</a>
      <a class="navlink" href="/settings">Settings</a>
    </div>
  </div>

  <section class="hero">
    <h1>Power</h1>
    <p>Victron SmartSolar charging status.</p>

    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
      <span class="pill"><span id="statusText">Loading…</span></span>
      <button id="refreshBtn" class="btn btn-primary">Refresh</button>
    </div>
  </section>

  <section class="section">
    <div class="card">
      <div class="card-h">
        <h2>Charging &amp; Battery</h2>
        <span class="badge" id="devBadge">—</span>
      </div>

      <div class="card-b">
        <div id="summaryArea"></div>
        <div id="msgWrap"></div>

        <details style="margin-top:14px">
          <summary style="font-weight:900">Raw payload</summary>
          <pre id="raw" style="margin-top:10px">(empty)</pre>
        </details>
      </div>
    </div>
  </section>

</div>

<script>
const $ = id => document.getElementById(id);
const esc = s => (s ?? "").toString().replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
function kv(k,v){ return `<div class="kv"><div class="k">${esc(k)}</div><div class="v">${esc(v ?? "—")}</div></div>`; }

function setMsg(text, kind){
  const wrap = $("msgWrap");
  if (!text) { wrap.innerHTML = ""; return; }
  const cls = kind === "err" ? "msg err" : "msg";
  wrap.innerHTML = `<div class="${cls}">${esc(text)}</div>`;
}

async function readJsonOrThrow(res){
  const ct = (res.headers.get("content-type") || "").toLowerCase();
  if (ct.includes("application/json")){
    const j = await res.json();
    if (!res.ok) throw new Error(j.detail || ("HTTP " + res.status));
    return j;
  }
  const t = await res.text();
  throw new Error(t || ("HTTP " + res.status));
}

async function api(url, opts){
  const res = await fetch(url, opts);
  return readJsonOrThrow(res);
}

function fmtNum(n, suffix){
  if (n === null || n === undefined || Number.isNaN(Number(n))) return "—";
  return `${Number(n).toFixed(2)}${suffix || ""}`;
}
function fmtInt(n, suffix){
  if (n === null || n === undefined || Number.isNaN(Number(n))) return "—";
  return `${Math.round(Number(n))}${suffix || ""}`;
}

function renderPower(p){
  const name = p?.name || "Unknown";
  $("devBadge").textContent = name;

  const state = p?.state || "Unknown";
  const stage = (p?.charge_state === null || p?.charge_state === undefined) ? "—" : `${p.charge_state} (${state})`;

  let html = "";
  html += kv("State", state);
  html += kv("Charge stage", stage);
  html += kv("Battery voltage", fmtNum(p?.voltage, " V"));
  html += kv("Charging current", fmtNum(p?.current, " A"));
  html += kv("Solar power", fmtInt(p?.solar_w ?? p?.power_w, " W"));
  html += kv("External device load", fmtInt(p?.load_w, " W"));
  html += kv("Last update", new Date().toLocaleTimeString());

  $("summaryArea").innerHTML = html;

  $("raw").textContent = JSON.stringify(p?.raw || {}, null, 2);
}

async function refreshPower(){
  $("statusText").textContent = "Refreshing…";
  setMsg("", null);

  try{
    const p = await api("/api/power", { cache: "no-store" });
    if (!p || !p.ok){
      $("statusText").textContent = "Error";
      setMsg("Power data not available.", "err");
      $("raw").textContent = JSON.stringify(p, null, 2);
      return;
    }
    renderPower(p);
    $("statusText").textContent = "Ready";
  }catch(e){
    $("statusText").textContent = "Error";
    setMsg(e.message || String(e), "err");
  }
}

$("refreshBtn").addEventListener("click", refreshPower);

(async () => {
  await refreshPower();
  setInterval(refreshPower, 5000);
})();
</script>
</body>
</html>
