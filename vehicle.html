<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vehicle</title>
  <link rel="stylesheet" href="/static/app.css">

  <style>
    .topnav{display:flex;gap:10px;justify-content:space-between;margin-bottom:12px}
    .navlinks{display:flex;gap:10px;flex-wrap:wrap}
    .navlink{padding:10px 14px;border-radius:999px;font-weight:900;text-decoration:none;background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.25)}
    .navlink.active{background:rgba(255,255,255,.25)}

    .vehicle-grid{display:grid;grid-template-columns:1fr 420px;gap:14px}
    @media(max-width:980px){.vehicle-grid{grid-template-columns:1fr}}

    .map{width:100%;height:260px;border:0;border-radius:18px;background:#eee}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:10px;padding:8px 0;border-bottom:1px dashed rgba(0,0,0,.15)}
    .k{font-weight:900}
    .v{font-weight:800;word-break:break-word}

    .msg{margin-top:12px;padding:10px 12px;border-radius:14px;font-weight:900;background:rgba(255,255,255,.55)}
    .msg.err{background:rgba(255,0,0,.10)}
  </style>
</head>

<body class="bg">
<div class="wrap">

  <div class="topnav">
    <div class="navlinks">
      <a class="navlink" href="/">Home</a>
      <a class="navlink" href="/wifi">WiFi</a>
      <a class="navlink active" href="/vehicle">Vehicle</a>
      <a class="navlink" href="/power">Power</a>
      <a class="navlink" href="/settings">Settings</a>
    </div>
  </div>

  <section class="hero">
    <h1>Vehicle</h1>
    <p>Static configured VIN. Manage it in Settings.</p>

    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
      <span class="pill"><span id="statusText">Ready</span></span>
      <button id="refreshBtn" class="btn btn-primary">Refresh</button>
      <a class="btn btn-ghost" href="/settings">Change VIN</a>
    </div>
  </section>

  <section class="section">
    <div class="vehicle-grid">

      <div class="card">
        <div class="card-h">
          <h2>Vehicle summary</h2>
          <span class="badge" id="vinBadge">—</span>
        </div>
        <div class="card-b">
          <div id="summaryArea"></div>
          <div id="msgWrap"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <h2>Location</h2>
        </div>
        <div class="card-b">
          <iframe id="mapFrame" class="map" src="about:blank" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
          <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
            <a id="mapsLink" class="mini-btn" target="_blank" rel="noopener noreferrer" style="display:none">Open in Google Maps</a>
          </div>

          <h3 style="margin-top:14px">Address</h3>
          <div id="addressFields"></div>
        </div>
      </div>

    </div>
  </section>

</div>

<script>
const $ = id => document.getElementById(id);
const esc = s => (s ?? "").toString().replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
const pick = (...v)=>v.map(x=>x?.toString().trim()).find(x=>x && !["none","null"].includes(x.toLowerCase()))||"";

function kv(k,v){return `<div class="kv"><div class="k">${esc(k)}</div><div class="v">${esc(v ?? "—")}</div></div>`}

function setMsg(text, kind){
  const wrap = $("msgWrap");
  if (!text) { wrap.innerHTML = ""; return; }
  const cls = kind === "err" ? "msg err" : "msg";
  wrap.innerHTML = `<div class="${cls}">${esc(text)}</div>`;
}

async function readJsonOrThrow(res){
  const ct = (res.headers.get("content-type") || "").toLowerCase();
  if (ct.includes("application/json")){
    const j = await res.json();
    if (!res.ok) throw new Error(j.detail || ("HTTP " + res.status));
    return j;
  }
  const t = await res.text();
  throw new Error(t || ("HTTP " + res.status));
}

async function api(url, opts){
  const res = await fetch(url, opts);
  return readJsonOrThrow(res);
}

function setMap(lat,lon){
  lat = pick(lat); lon = pick(lon);
  if(!lat || !lon){
    $("mapFrame").src = "about:blank";
    $("mapsLink").style.display = "none";
    return;
  }
  $("mapFrame").src = `https://www.google.com/maps?q=${encodeURIComponent(lat + "," + lon)}&output=embed&t=${Date.now()}`;
  $("mapsLink").href = `https://www.google.com/maps?q=${encodeURIComponent(lat + "," + lon)}`;
  $("mapsLink").style.display = "inline-block";
}

function renderFromPayload(payload){
  const vin = payload?.vin;
  const summary = payload?.summary || {};
  const extras = payload?.extras || {};

  if (vin) $("vinBadge").textContent = vin;

  let html = "";
  html += kv("Name", summary.data?.name);
  html += kv("Model", summary.data?.model);
  html += kv("Odometer", summary.data?.odometer);
  html += kv("Drive level", extras.drive_level ?? "—");
  html += kv("Total range", extras.total_range ?? "—");
  $("summaryArea").innerHTML = html;

  const lat = pick(summary.coords?.latitude, summary.data?.addr_lat, summary.data?.pos_lat);
  const lon = pick(summary.coords?.longitude, summary.data?.addr_lon, summary.data?.pos_lon);
  setMap(lat, lon);

  const a = summary.address || {};
  const d = summary.data || {};
  const fields = [
    ["Display name", pick(a.display_name, d.addr_display_name)],
    ["Name",         pick(a.name,         d.addr_name)],
    ["Road",         pick(a.road,         d.addr_road)],
    ["Postcode",     pick(a.postcode,     d.addr_postcode)],
    ["County",       pick(a.county,       d.addr_county)],
    ["State",        pick(a.state,        d.addr_state)],
    ["Country",      pick(a.country,      d.addr_country)],
  ];

  let ahtml = "";
  for (const [k, v] of fields){
    if (v) ahtml += kv(k, v);
  }
  $("addressFields").innerHTML = ahtml || "<div class='meta'>No address data</div>";
}

async function loadConfiguredVin(){
  const s = await api("/api/settings");
  if (!s.vin){
    $("statusText").textContent = "No VIN set";
    setMsg("No VIN configured. Go to Settings and choose a vehicle.", "err");
    return null;
  }
  return s.vin;
}

async function loadFromCacheFirst(){
  try{
    const c = await api("/api/vehicle_cache");
    if (c && c.ok && c.summary){
      $("statusText").textContent = "Loaded (cached)";
      renderFromPayload(c);
      return true;
    }
  } catch {}
  return false;
}

async function refreshLive(){
  $("statusText").textContent = "Refreshing…";
  setMsg("", null);

  const vin = await loadConfiguredVin();
  if (!vin) return;

  const summary = await api(`/api/vw/summary?vin=${encodeURIComponent(vin)}`);

  const driveLevelPath = `/garage/${vin}/drives/primary/level`;
  const rangePath = `/garage/${vin}/drives/total_range`;

  let driveLevel = null;
  let totalRange = null;

  try { driveLevel = (await api(`/api/vw/get?path=${encodeURIComponent(driveLevelPath)}`)).value; } catch {}
  try { totalRange = (await api(`/api/vw/get?path=${encodeURIComponent(rangePath)}`)).value; } catch {}

  const payload = {
    ok: true,
    vin,
    fetched_at: Math.floor(Date.now()/1000),
    summary,
    extras: { drive_level: driveLevel, total_range: totalRange }
  };

  renderFromPayload(payload);

  try{ await api("/api/vw/preload", { method: "POST" }); } catch {}

  $("statusText").textContent = "Ready";
}

$("refreshBtn").addEventListener("click", refreshLive);

(async () => {
  await loadFromCacheFirst();
  const vin = await loadConfiguredVin();
  if (!vin) return;
  await refreshLive();
})();
</script>
</body>
</html>
